name: Performance Budget Check

on:
  pull_request:
    branches:
      - main

jobs:
  bundle-analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build and analyze
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}
          VITE_SUPABASE_PROJECT_ID: ${{ secrets.VITE_SUPABASE_PROJECT_ID }}
          
      - name: Analyze bundle size
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Read build stats
            const distPath = './dist';
            let totalSize = 0;
            let jsSize = 0;
            let cssSize = 0;
            
            function getDirectorySize(dir) {
              const files = fs.readdirSync(dir);
              
              files.forEach(file => {
                const filePath = path.join(dir, file);
                const stat = fs.statSync(filePath);
                
                if (stat.isDirectory()) {
                  getDirectorySize(filePath);
                } else {
                  totalSize += stat.size;
                  
                  if (file.endsWith('.js')) {
                    jsSize += stat.size;
                  } else if (file.endsWith('.css')) {
                    cssSize += stat.size;
                  }
                }
              });
            }
            
            getDirectorySize(path.join(distPath, 'assets'));
            
            // Budget thresholds (in bytes)
            const budgets = {
              total: 2 * 1024 * 1024,  // 2MB
              js: 1.5 * 1024 * 1024,   // 1.5MB
              css: 200 * 1024          // 200KB
            };
            
            // Check budgets
            const totalPassed = totalSize <= budgets.total;
            const jsPassed = jsSize <= budgets.js;
            const cssPassed = cssSize <= budgets.css;
            
            const format = (bytes) => `${(bytes / 1024 / 1024).toFixed(2)}MB`;
            
            const comment = `## ðŸ“Š Bundle Size Analysis
            
            | Asset Type | Size | Budget | Status |
            |------------|------|--------|--------|
            | Total | ${format(totalSize)} | ${format(budgets.total)} | ${totalPassed ? 'âœ…' : 'âŒ'} |
            | JavaScript | ${format(jsSize)} | ${format(budgets.js)} | ${jsPassed ? 'âœ…' : 'âŒ'} |
            | CSS | ${(cssSize / 1024).toFixed(2)}KB | ${(budgets.css / 1024).toFixed(0)}KB | ${cssPassed ? 'âœ…' : 'âŒ'} |
            
            ${!totalPassed || !jsPassed || !cssPassed ? 'âš ï¸ **Warning:** Some assets exceed the performance budget!' : 'âœ… All assets are within budget!'}
            
            ### Recommendations
            ${!jsPassed ? '- Consider code splitting or removing unused dependencies\n' : ''}
            ${!cssPassed ? '- Review CSS for unused styles or duplicate declarations\n' : ''}
            ${!totalPassed ? '- Consider lazy loading or async loading for non-critical resources\n' : ''}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
            // Fail the workflow if budgets are exceeded significantly
            if (totalSize > budgets.total * 1.2 || jsSize > budgets.js * 1.2) {
              core.setFailed('Bundle size significantly exceeds budget!');
            }
